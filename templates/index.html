<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cowrie Honeypot Dashboard - Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS and JS for world map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @keyframes pulse-red {
            0%, 100% { background-color: rgba(239, 68, 68, 0.1); }
            50% { background-color: rgba(239, 68, 68, 0.3); }
        }
        .alert-high { animation: pulse-red 2s infinite; }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .stat-card {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .smooth-transition {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* Custom map styles */
        .leaflet-container {
            background: #1f2937;
            border-radius: 8px;
        }
        .attack-marker {
            background: #ef4444;
            border: 2px solid #ffffff;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            animation: pulse-marker 2s infinite;
        }
        .attack-marker.heat-high {
            background: #dc2626;
            width: 16px;
            height: 16px;
        }
        .attack-marker.heat-medium {
            background: #f59e0b;
            width: 14px;
            height: 14px;
        }
        .attack-marker.heat-low {
            background: #10b981;
            width: 10px;
            height: 10px;
        }
        @keyframes pulse-marker {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
        .country-label {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 min-h-screen text-white">
    <!-- Header -->
    <header class="glass-effect p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-shield-alt text-2xl text-blue-400"></i>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                    Cowrie Honeypot Dashboard
                </h1>
            </div>
            <div class="flex items-center space-x-4">
                <span id="connection-status" class="flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span>
                    <span class="text-sm">Connected</span>
                </span>
                <button onclick="exportCredentials()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span>Export CSV</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
        <!-- Stats Overview -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Total Connections</p>
                        <p id="total-connections" class="text-3xl font-bold text-blue-400">0</p>
                    </div>
                    <i class="fas fa-network-wired text-3xl text-blue-400 opacity-50"></i>
                </div>
            </div>
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Failed Logins</p>
                        <p id="failed-logins" class="text-3xl font-bold text-red-400">0</p>
                    </div>
                    <i class="fas fa-times-circle text-3xl text-red-400 opacity-50"></i>
                </div>
            </div>
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div class="cursor-pointer hover:bg-white hover:bg-opacity-10 rounded p-2 smooth-transition" onclick="showSuccessfulLoginsModal()">
                        <p class="text-gray-300 text-sm">Successful Logins</p>
                        <p id="successful-logins" class="text-3xl font-bold text-green-400">0</p>
                    </div>
                    <i class="fas fa-check-circle text-3xl text-green-400 opacity-50"></i>
                </div>
            </div>
            <div class="stat-card glass-effect p-6 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-300 text-sm">Unique IPs</p>
                        <p id="unique-ips" class="text-3xl font-bold text-purple-400">0</p>
                    </div>
                    <i class="fas fa-globe text-3xl text-purple-400 opacity-50"></i>
                </div>
            </div>
        </section>

        <!-- Charts and Tables -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Attack Timeline Chart -->
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-line mr-2 text-blue-400"></i>
                    Attack Timeline
                </h2>
                <div class="relative bg-gray-800 rounded" style="height: 300px; max-height: 300px; overflow: hidden;">
                    <canvas id="timeline-chart" style="width: 100%; height: 100%; max-width: 100%; max-height: 100%;"></canvas>
                </div>
            </div>

            <!-- World Attack Map -->
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-globe-americas mr-2 text-green-400"></i>
                    World Attack Map
                    <span class="ml-auto text-sm text-gray-400">
                        <span id="attack-count">0</span> attacks
                    </span>
                </h2>
                <div class="relative bg-gray-800 rounded" style="height: 300px; max-height: 300px; overflow: hidden;">
                    <div id="world-map" style="width: 100%; height: 100%;"></div>
                    <div id="map-tooltip" class="absolute bg-gray-900 text-white text-xs rounded px-2 py-1 pointer-events-none opacity-0 transition-opacity duration-200" style="z-index: 1000;"></div>
                </div>
                <div class="mt-2 flex justify-between text-xs text-gray-400">
                    <span>üî¥ Live attacks</span>
                    <span>Click markers for details</span>
                </div>
            </div>
        </div>

        

        <!-- Top Countries & Organizations -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-flag mr-2 text-purple-400"></i>
                    Top Countries
                </h2>
                <div id="top-countries-chart"></div>
            </div>
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-building mr-2 text-orange-400"></i>
                    Top Organizations
                </h2>
                <div id="top-organizations-chart"></div>
            </div>
        </div>
<!-- Recent Attacks Table -->
        <div class="glass-effect p-6 rounded-xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-history mr-2 text-green-400"></i>
                    Recent Attacks
                </h2>
                <div class="flex space-x-2">
                    <select id="export-format" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm">
                        <option value="json">JSON</option>
                        <option value="csv">CSV</option>
                    </select>
                    <button onclick="exportLogs()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                        <i class="fas fa-download"></i>
                        <span>Export Logs</span>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto overflow-y-auto" style="max-height: 600px;">
                <table class="w-full text-sm">
                    <thead class="sticky top-0 bg-gray-800">
                        <tr class="border-b border-gray-700">
                            <th class="text-left p-2">Time</th>
                            <th class="text-left p-2">IP</th>
                            <th class="text-left p-2">Country</th>
                            <th class="text-left p-2">Event</th>
                            <th class="text-left p-2">Username</th>
                            <th class="text-left p-2">Password</th>
                        </tr>
                    </thead>
                    <tbody id="recent-attacks">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Alerts Section -->
        <div class="glass-effect p-6 rounded-xl mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold flex items-center">
                    <i class="fas fa-exclamation-triangle mr-2 text-red-400"></i>
                    Security Alerts
                </h2>
                <button onclick="exportAlerts()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg smooth-transition flex items-center space-x-2">
                    <i class="fas fa-download"></i>
                    <span>Export Alerts</span>
                </button>
            </div>
            <div id="alerts-container" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Dynamic alerts -->
            </div>
        </div>
        <!-- Top Passwords & Users & IPs -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-network-wired mr-2 text-green-400"></i>
                    Top IPs
                </h2>
                <div id="top-ips"></div>
            </div>
            
            <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-user mr-2 text-blue-400"></i>
                    Top Users
                </h2>
                <div id="top-users"></div>
            </div>
           <div class="glass-effect p-6 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-key mr-2 text-yellow-400"></i>
                    Top Passwords
                </h2>
                <div id="top-passwords"></div>
            </div>
        </div>
    </main>

    <!-- Export Modal -->
    <div id="export-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="glass-effect p-6 rounded-xl max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Export Credentials</h3>
            <div class="space-y-4">
                <label class="flex items-center space-x-2">
                    <input type="checkbox" id="success-only" class="rounded">
                    <span>Export successful logins only</span>
                </label>
                <div class="flex space-x-4">
                    <button onclick="confirmExport()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg smooth-transition">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="closeExportModal()" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg smooth-transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let timelineChart;
        let stats = {};
        let updateTimeout;
        let lastUpdateTime = 0;
        let worldMap;
        let attackMarkers = [];
        let heatmapEnabled = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            initializeMaps();
            loadInitialData();
        });

        // Socket.IO connection
        function initializeSocket() {
            console.log('üîå Initializing Socket.IO connection...');
            
            try {
                window.socket = io();
                
                window.socket.on('connect', function() {
                    console.log('‚úÖ Socket.IO connected successfully');
                    updateConnectionStatus(true);
                });
                
                window.socket.on('disconnect', function() {
                    console.log('‚ùå Socket.IO disconnected');
                    updateConnectionStatus(false);
                });
                
                window.socket.on('connect_error', function(error) {
                    console.log('‚ùå Socket.IO connection error:', error);
                    updateConnectionStatus(false);
                });
                
                window.socket.on('stats_update', function(data) {
                    console.log('üìä Received stats update:', data);
                    updateStats(data);
                });
                
                window.socket.on('log_entry', function(entry) {
                    console.log('üìù Received log entry:', entry);
                    handleNewAttack(entry);
                });
                
                window.socket.on('new_attack', function(data) {
                    console.log('üéØ Received new attack:', data);
                    handleNewAttack(data);
                });
                
                window.socket.on('alert', function(alert) {
                    console.log('üö® Received alert:', alert);
                    addAlert(alert);
                });
                
            } catch (error) {
                console.log('‚ùå Socket.IO initialization error:', error);
                updateConnectionStatus(false);
            }
        }
        
        // Country center coordinates for fallback when precise geo data is missing
        const countryCoords = {
            "Vietnam": [14.0583, 108.2772],
            "United States": [37.0902, -95.7129],
            "Russia": [61.5240, 105.3188],
            "India": [20.5937, 78.9629],
            "China": [35.8617, 104.1954],
            "Japan": [36.2048, 138.2529],
            "Germany": [51.1657, 10.4515],
            "United Kingdom": [55.3781, -3.4360],
            "France": [46.2276, 2.2137],
            "Brazil": [-14.2350, -51.9253],
            "Canada": [56.1304, -106.3468],
            "Australia": [-25.2744, 133.7751],
            "South Korea": [35.9078, 127.7669],
            "Netherlands": [52.1326, 5.2913],
            "Sweden": [60.1282, 18.6435],
            "Poland": [51.9194, 19.1451],
            "Italy": [41.8719, 12.5674],
            "Spain": [40.4637, -3.7492],
            "Turkey": [38.9637, 35.2433],
            "Thailand": [15.8700, 100.9925],
            "Indonesia": [-0.7893, 113.9213],
            "Philippines": [12.8797, 121.7740],
            "Malaysia": [4.2105, 101.9758],
            "Singapore": [1.3521, 103.8198],
            "Taiwan": [23.6978, 120.9605],
            "Hong Kong": [22.3193, 114.1694],
            "Israel": [31.0461, 34.8516],
            "United Arab Emirates": [23.4241, 53.8478],
            "Saudi Arabia": [23.8859, 45.0792],
            "South Africa": [-30.5595, 22.9375],
            "Mexico": [23.6345, -102.5528],
            "Argentina": [-38.4161, -63.6167],
            "Chile": [-35.6751, -71.5430],
            "Colombia": [4.5709, -74.2973],
            "Peru": [-9.1900, -75.0152],
            "Egypt": [26.0963, 29.9876],
            "Nigeria": [9.0820, 8.6753],
            "Kenya": [-1.2921, 36.8219],
            "Unknown": [0, 0]  // Default for unknown countries
        };
        
        // Function to get coordinates for an attack, using fallback if needed
        function getAttackCoordinates(attack) {
            let lat = attack.latitude;
            let lng = attack.longitude;
            
            if (!lat || !lng) {
                if (attack.country && countryCoords[attack.country]) {
                    lat = countryCoords[attack.country][0];
                    lng = countryCoords[attack.country][1];
                    console.log(`üåç Using fallback coordinates for ${attack.country}: ${lat}, ${lng}`);
                }
            }
            
            return { latitude: lat, longitude: lng };
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connection-status');
            if (connected) {
                status.innerHTML = '<span class="w-3 h-3 bg-green-500 rounded-full animate-pulse mr-2"></span><span class="text-sm">Connected</span>';
            } else {
                status.innerHTML = '<span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span><span class="text-sm">Disconnected</span>';
            }
        }

        // Initialize charts
        function initializeCharts() {
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            window.timelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Attacks Over Time',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: false,
                    maintainAspectRatio: false,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            labels: { color: 'white' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Initialize maps
        function initializeMaps() {
            console.log('üó∫Ô∏è Initializing world map...');
            
            // World Attack Map
            window.worldMap = L.map('world-map', {
                center: [20, 0],
                zoom: 2,
                zoomControl: true,
                attributionControl: true
            });
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors ¬© CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(window.worldMap);
            
            // Add initial attack markers from recent attacks (limit to 500 for performance)
            if (stats.recent_attacks) {
                console.log('Adding initial attack markers:', stats.recent_attacks.length);
                const attacksToProcess = stats.recent_attacks.slice(0, 500);
                attacksToProcess.forEach(attack => {
                    const coords = getAttackCoordinates(attack);
                    if (coords.latitude && coords.longitude) {
                        addAttackMarker({ ...attack, latitude: coords.latitude, longitude: coords.longitude });
                    }
                });
            }
            
            console.log('‚úÖ World map initialized successfully');
        }

        // Add attack marker to map
        function addAttackMarker(attack) {
            if (!attack.latitude || !attack.longitude) return;
            
            const heatLevel = getHeatLevel(attack.ip);
            const markerClass = heatLevel === 'high' ? 'heat-high' : heatLevel === 'medium' ? 'heat-medium' : 'heat-low';
            
            // Create custom icon
            const icon = L.divIcon({
                className: `attack-marker ${markerClass}`,
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            
            // Add to world map
            const marker = L.marker([attack.latitude, attack.longitude], { icon })
                .addTo(window.worldMap)
                .bindPopup(`
                    <div class="text-xs">
                        <strong>IP:</strong> ${attack.ip}<br>
                        <strong>Country:</strong> ${attack.country || 'Unknown'}<br>
                        <strong>Time:</strong> ${new Date(attack.timestamp).toLocaleString()}<br>
                        <strong>Event:</strong> ${attack.event || 'Unknown'}<br>
                        <strong>Username:</strong> ${attack.username || 'N/A'}<br>
                        <strong>Password:</strong> ${attack.password || 'N/A'}
                    </div>
                `);
            
            attackMarkers.push({ marker, attack });
            updateAttackCount();
        }

        // Get heat level based on attack frequency
        function getHeatLevel(ip) {
            const recentAttacks = stats.recent_attacks || [];
            const ipAttacks = recentAttacks.filter(a => a.ip === ip);
            
            if (ipAttacks.length >= 5) return 'high';
            if (ipAttacks.length >= 3) return 'medium';
            return 'low';
        }

        // Update attack count display
        function updateAttackCount() {
            const count = attackMarkers.length;
            document.getElementById('attack-count').textContent = count;
        }

        // Reset map markers
        function resetMap() {
            attackMarkers.forEach(({ marker }) => {
                window.worldMap.removeLayer(marker);
            });
            attackMarkers = [];
            updateAttackCount();
            
            // Re-add from current stats
            if (stats.recent_attacks) {
                stats.recent_attacks.forEach(attack => {
                    if (attack.latitude && attack.longitude) {
                        addAttackMarker(attack);
                    }
                });
            }
        }

        // Toggle heatmap view
        function toggleHeatmap() {
            heatmapEnabled = !heatmapEnabled;
            
            if (heatmapEnabled) {
                // Show heatmap layer (simplified - just change marker sizes)
                attackMarkers.forEach(({ marker }) => {
                    const icon = marker.getIcon();
                    icon.options.iconSize = [20, 20];
                    marker.setIcon(icon);
                });
            } else {
                // Reset to normal sizes
                attackMarkers.forEach(({ marker }) => {
                    const icon = marker.getIcon();
                    const popupContent = marker.getPopup().getContent();
                    const ipMatch = popupContent.match(/IP: ([\d.]+)/);
                    if (ipMatch) {
                        const heatLevel = getHeatLevel(ipMatch[1]);
                        const size = heatLevel === 'high' ? 16 : heatLevel === 'medium' ? 14 : 12;
                        icon.options.iconSize = [size, size];
                        marker.setIcon(icon);
                    }
                });
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                console.log('üìä Loading initial data...');
                const response = await fetch('http://192.168.1.19:3333/api/stats', {
                    headers: {
                        'Authorization': 'Basic ' + btoa('admin:Cowrie@2026!')
                    }
                });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                stats = await response.json();
                console.log('ÔøΩ Initial data loaded:', {
                    total_connections: stats.total_connections,
                    recent_attacks_count: stats.recent_attacks?.length,
                    top_ips_type: Array.isArray(stats.top_ips) ? 'array' : typeof stats.top_ips,
                    top_users_type: Array.isArray(stats.top_users) ? 'array' : typeof stats.top_users,
                    top_passwords_type: Array.isArray(stats.top_passwords) ? 'array' : typeof stats.top_passwords
                });
                updateStats(stats);
                
                // Explicitly update timeline chart
                if (stats.recent_attacks) {
                    console.log('ÔøΩ Updating timeline chart with initial data...');
                    updateTimelineChart(stats.recent_attacks);
                }
                
                // Explicitly add map markers (limit to 500 for performance)
                if (stats.recent_attacks && window.worldMap) {
                    console.log('üó∫Ô∏è Adding initial map markers for', stats.recent_attacks.length, 'attacks...');
                    let markerCount = 0;
                    const attacksToProcess = stats.recent_attacks.slice(0, 500);
                    attacksToProcess.forEach((attack, index) => {
                        const coords = getAttackCoordinates(attack);
                        console.log(`üó∫Ô∏è Attack ${index}: lat=${coords.latitude}, lng=${coords.longitude}, ip=${attack.ip}`);
                        if (coords.latitude && coords.longitude) {
                            addAttackMarker({ ...attack, latitude: coords.latitude, longitude: coords.longitude });
                            markerCount++;
                        }
                    });
                    console.log('üó∫Ô∏è Added', markerCount, 'map markers');
                    updateAttackCount();
                } else {
                    console.log('üó∫Ô∏è Skipping map markers - attacks:', !!stats.recent_attacks, 'map:', !!window.worldMap);
                }
            } catch (error) {
                console.error('‚ùå Error loading initial data:', error.message);
                // Set default empty values to prevent errors
                stats = {
                    top_countries: {},
                    top_organizations: {},
                    recent_attacks: [],
                    top_passwords: [],
                    total_connections: 0,
                    failed_logins: 0,
                    successful_logins: 0,
                    unique_ips: 0
                };
                updateStats(stats);
            }
        }

        // Debounced update function
        function debouncedUpdateStats(data, delay = 500) {
            console.log('debouncedUpdateStats called, delay:', delay);
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                console.log('Executing debounced update');
                updateStats(data);
            }, delay);
        }

        // Reset map markers
        function resetMap() {
            attackMarkers.forEach(({ marker }) => {
                window.worldMap.removeLayer(marker);
            });
            attackMarkers = [];
            updateAttackCount();
            
            // Re-add from current stats
            if (stats.recent_attacks) {
                stats.recent_attacks.forEach(attack => {
                    if (attack.latitude && attack.longitude) {
                        addAttackMarker(attack);
                    }
                });
            }
        }

        // Update stats
        function updateStats(data) {
            console.log('updateStats called with:', data);
            
            // Comprehensive null check - allow empty objects but reject null/undefined
            if (data === null || data === undefined || typeof data !== 'object') {
                console.log('updateStats: Invalid data provided, skipping update');
                return;
            }
            
            // Update statistics with null checks
            document.getElementById('total-connections').textContent = data.total_connections || 0;
            document.getElementById('failed-logins').textContent = data.failed_logins || 0;
            document.getElementById('successful-logins').textContent = data.successful_logins || 0;
            document.getElementById('unique-ips').textContent = data.unique_ips || 0;
            
            // Update top passwords with null check
            if (data.top_passwords && typeof data.top_passwords === 'object') {
                updateTopPasswords(data.top_passwords);
            }
            
            // Update recent attacks with null check
            if (data.recent_attacks && Array.isArray(data.recent_attacks)) {
                updateRecentAttacks(data.recent_attacks);
            }
            
            // Update top countries with null check
            if (data.top_countries && typeof data.top_countries === 'object') {
                console.log('üåç Calling updateTopCountries with data:', data.top_countries);
                updateTopCountries(data.top_countries);
            } else {
                console.log('üåç No top_countries data available:', data.top_countries);
            }
            
            // Update top organizations with null check
            if (data.top_organizations && typeof data.top_organizations === 'object') {
                updateTopOrganizations(data.top_organizations);
            }
            
            // Update top IPs with null check
            if (data.top_ips && typeof data.top_ips === 'object') {
                updateTopIPs(data.top_ips);
            }
            
            // Update top users with null check
            if (data.top_users && typeof data.top_users === 'object') {
                updateTopUsers(data.top_users);
            }
            
            // Update timeline chart with null check
            if (data.recent_attacks && Array.isArray(data.recent_attacks)) {
                updateTimelineChart(data.recent_attacks);
            }
        }

        // Update stat card with animation
        function updateStatCard(elementId, value) {
            const element = document.getElementById(elementId);
            const currentValue = parseInt(element.textContent) || 0;
            const increment = (value - currentValue) / 20;
            let current = currentValue;
            
            const animation = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= value) || (increment < 0 && current <= value)) {
                    element.textContent = value.toLocaleString();
                    clearInterval(animation);
                } else {
                    element.textContent = Math.round(current).toLocaleString();
                }
            }, 50);
        }

        // Update top passwords
        function updateTopPasswords(passwords) {
            const container = document.getElementById('top-passwords');
            if (!passwords || !Array.isArray(passwords)) {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No passwords data available</div>';
                return;
            }
            container.innerHTML = passwords
                .slice(0, 200) // Top 200 passwords
                .map(([password, count], index) => `
                    <div class="flex justify-between items-center p-2 hover:bg-white hover:bg-opacity-10 rounded smooth-transition">
                        <span class="flex items-center">
                            <span class="text-yellow-400 mr-2">#${index + 1}</span>
                            <span class="font-mono text-sm">${password || '<empty>'}</span>
                        </span>
                        <span class="bg-blue-600 px-2 py-1 rounded text-xs">${count}</span>
                    </div>
                `).join('');
        }

        // Update recent attacks
        function updateRecentAttacks(attacks) {
            const tbody = document.getElementById('recent-attacks');
            tbody.innerHTML = attacks.slice(0, 500).map(attack => `
                <tr class="border-b border-gray-800 hover:bg-white hover:bg-opacity-5 smooth-transition">
                    <td class="p-2 text-xs">${formatTime(attack.timestamp)}</td>
                    <td class="p-2 font-mono text-sm">${attack.ip}</td>
                    <td class="p-2">${attack.country || 'Unknown'}</td>
                    <td class="p-2">
                        <span class="px-2 py-1 rounded text-xs ${
                            attack.event === 'connection' ? 'bg-blue-600' : 
                            attack.event === 'login.success' ? 'bg-green-600' : 'bg-red-600'
                        }">
                            ${attack.event || 'Unknown'}
                        </span>
                    </td>
                    <td class="p-2 font-mono text-sm">${attack.username || '-'}</td>
                    <td class="p-2 font-mono text-sm">${truncateText(attack.password || '-', 15)}</td>
                </tr>
            `).join('');
        }

                // Update top countries chart
        function updateTopCountries(countries) {
            console.log('üåç updateTopCountries called with:', countries?.length || 0, 'countries');
            
            // Convert dict to array if needed
            if (typeof countries === 'object' && !Array.isArray(countries)) {
                console.log('üåç Converting dict to array...');
                countries = Object.entries(countries);
                console.log('üåç After conversion:', countries);
            }
            
            const container = document.getElementById('top-countries-chart');
            console.log('üåç Container element:', container);
            if (!container) {
                console.log('‚ùå Top countries container not found');
                return;
            }
            
            // Prepare chart data
            console.log('üåç Preparing chart data...');
            try {
                if (!Array.isArray(countries) || countries.length === 0) {
                    console.log('üåç No countries data, showing message');
                    container.innerHTML = '<div class="text-gray-400 text-sm p-2">No countries data available</div>';
                    return;
                }
                
                const chartData = countries.sort((a, b) => b[1] - a[1]).slice(0, 10);
                console.log('üåç chartData after array processing:', chartData);
                
                const labels = chartData.map(([country]) => country);
                const data = chartData.map(([, count]) => count);
                
                console.log('üåç Chart data prepared:', { labels, data, chartData });
                
                // Check if chart already exists
                const canvas = document.getElementById('countries-chart');
                if (!canvas) {
                    console.log('üåç Creating chart container for first time');
                    // Create chart container
                    container.innerHTML = '<div class="relative" style="height: 300px;"><canvas id="countries-chart"></canvas></div>';
                }
                
                const ctx = document.getElementById('countries-chart').getContext('2d');
                console.log('üåç Canvas context:', ctx);
                
                if (window.countriesChart) {
                    console.log('üåç Updating existing chart data');
                    // Update existing chart data instead of recreating
                    window.countriesChart.data.labels = labels;
                    window.countriesChart.data.datasets[0].data = data;
                    window.countriesChart.update('none'); // Update without animation for performance
                } else {
                    console.log('üåç Creating new Chart.js chart');
                    // Create new chart
                    window.countriesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Attack Count',
                                data: data,
                                backgroundColor: 'rgba(168, 85, 247, 0.6)',
                                borderColor: 'rgba(168, 85, 247, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0 // Disable animation for better performance
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                }
                console.log('üåç Chart updated successfully');
            } catch (error) {
                console.error('üåç Error in chart creation:', error.message);
                console.error('üåç Error stack:', error.stack);
            }
        }

        // Update top organizations
        function updateTopOrganizations(organizations) {
            console.log('üè¢ updateTopOrganizations called with:', organizations);
            console.log('üè¢ organizations type:', typeof organizations, Array.isArray(organizations) ? 'array' : 'object');
            
            // Convert dict to array if needed
            if (typeof organizations === 'object' && !Array.isArray(organizations)) {
                console.log('üè¢ Converting dict to array...');
                organizations = Object.entries(organizations);
                console.log('üè¢ After conversion:', organizations);
            }
            
            const container = document.getElementById('top-organizations-chart');
            console.log('üè¢ Top organizations container:', container);
            if (!container) {
                console.log('‚ùå Top organizations container not found');
                return;
            }
            
            // Prepare chart data
            console.log('üè¢ Attempting direct array processing...');
            try {
                if (!Array.isArray(organizations) || organizations.length === 0) {
                    console.log('üè¢ No organizations data, showing message');
                    container.innerHTML = '<div class="text-gray-400 text-sm p-2">No organizations data available</div>';
                    return;
                }
                
                const chartData = organizations.sort((a, b) => b[1] - a[1]).slice(0, 10);
                console.log('üè¢ chartData after array processing:', chartData);
                
                const labels = chartData.map(([org]) => org);
                const data = chartData.map(([, count]) => count);
                
                console.log('üè¢ Chart data prepared:', { labels, data, chartData });
                
                // Check if chart already exists
                const canvas = document.getElementById('organizations-chart');
                if (!canvas) {
                    console.log('üè¢ Creating chart container for first time');
                    // Create chart container
                    container.innerHTML = '<div class="relative" style="height: 300px;"><canvas id="organizations-chart"></canvas></div>';
                }
                
                const ctx = document.getElementById('organizations-chart').getContext('2d');
                console.log('üè¢ Canvas context:', ctx);
                
                if (window.organizationsChart) {
                    console.log('üè¢ Updating existing chart data');
                    // Update existing chart data instead of recreating
                    window.organizationsChart.data.labels = labels;
                    window.organizationsChart.data.datasets[0].data = data;
                    window.organizationsChart.update('none'); // Update without animation for performance
                } else {
                    console.log('üè¢ Creating new Chart.js chart');
                    // Create new chart
                    window.organizationsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Attack Count',
                                data: data,
                                backgroundColor: 'rgba(251, 146, 60, 0.6)',
                                borderColor: 'rgba(251, 146, 60, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: {
                                duration: 0 // Disable animation for better performance
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)'
                                    }
                                },
                                x: {
                                    grid: {
                                        display: false
                                    },
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        maxRotation: 45,
                                        minRotation: 45
                                    }
                                }
                            }
                        }
                    });
                }
                console.log('üè¢ Chart updated successfully');
            } catch (error) {
                console.error('üè¢ Error in chart creation:', error.message);
                console.error('üè¢ Error stack:', error.stack);
            }
        }

        // Update top IPs
        function updateTopIPs(ips) {
            const container = document.getElementById('top-ips');
            if (!ips || !Array.isArray(ips)) {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No IPs data available</div>';
                return;
            }
            container.innerHTML = ips
                .slice(0, 200) // Top 200 IPs
                .map(([ip, count], index) => `
                    <div class="flex justify-between items-center p-2 hover:bg-white hover:bg-opacity-10 rounded smooth-transition">
                        <span class="flex items-center">
                            <span class="text-green-400 mr-2">#${index + 1}</span>
                            <span class="font-mono text-sm">${ip}</span>
                        </span>
                        <span class="bg-green-600 px-2 py-1 rounded text-xs">${count}</span>
                    </div>
                `).join('');
        }

        // Update top users
        function updateTopUsers(users) {
            const container = document.getElementById('top-users');
            if (!users || !Array.isArray(users)) {
                container.innerHTML = '<div class="text-gray-400 text-sm p-2">No users data available</div>';
                return;
            }
            container.innerHTML = users
                .slice(0, 200) // Top 200 users
                .map(([user, count], index) => `
                    <div class="flex justify-between items-center p-2 hover:bg-white hover:bg-opacity-10 rounded smooth-transition">
                        <span class="flex items-center">
                            <span class="text-blue-400 mr-2">#${index + 1}</span>
                            <span class="font-mono text-sm">${user || '<empty>'}</span>
                        </span>
                        <span class="bg-blue-600 px-2 py-1 rounded text-xs">${count}</span>
                    </div>
                `).join('');
        }

        // Update timeline chart
        function updateTimelineChart(attacks) {
            console.log('updateTimelineChart called with:', attacks?.length || 0, 'attacks');
            
            if (!window.timelineChart) {
                console.log('timelineChart not initialized');
                return;
            }
            
            // Limit attacks to 500 for performance
            const attacksToProcess = attacks ? attacks.slice(0, 500) : [];
            
            if (!attacksToProcess || attacksToProcess.length === 0) {
                console.log('No attacks data, clearing chart');
                // Clear chart if no data
                window.timelineChart.data.labels = [];
                window.timelineChart.data.datasets[0].data = [];
                window.timelineChart.update('none');
                return;
            }
            
            // Group attacks by minute (HH:MM format)
            const minuteData = {};
            const minutesWithData = new Set();
            
            attacksToProcess.forEach(attack => {
                const date = new Date(attack.timestamp);
                const hour = date.getHours().toString().padStart(2, '0');
                const minute = date.getMinutes().toString().padStart(2, '0');
                const timeKey = `${hour}:${minute}`;
                
                minuteData[timeKey] = (minuteData[timeKey] || 0) + 1;
                minutesWithData.add(timeKey);
            });
            
            // If no minute data, fall back to hour grouping
            if (minutesWithData.size === 0) {
                // Group attacks by hour
                const hourlyData = {};
                const hoursWithData = new Set();
                
                attacksToProcess.forEach(attack => {
                    const hour = new Date(attack.timestamp).getHours();
                    hourlyData[hour] = (hourlyData[hour] || 0) + 1;
                    hoursWithData.add(hour);
                });
                
                // Show last 24 hours even if empty
                const sortedHours = Array.from({length: 24}, (_, i) => i);
                const labels = sortedHours.map(hour => `${hour}:00`);
                const data = sortedHours.map(hour => hourlyData[hour] || 0);
                
                console.log('Chart data (hourly):', { labels, data });
                
                window.timelineChart.data.labels = labels;
                window.timelineChart.data.datasets[0].data = data;
            } else {
                // Show minute data
                const sortedMinutes = Array.from(minutesWithData).sort();
                const labels = sortedMinutes;
                const data = sortedMinutes.map(minute => minuteData[minute] || 0);
                
                console.log('Chart data (minute):', { labels, data });
                
                window.timelineChart.data.labels = labels;
                window.timelineChart.data.datasets[0].data = data;
            }
            
            window.timelineChart.update('none'); // Update without animation for performance
        }

        // Handle new attack
        function handleNewAttack(data) {
            console.log('handleNewAttack called with:', data);
            
            // Add attack marker to maps if coordinates available
            if (data.latitude && data.longitude) {
                addAttackMarker(data);
            } else if (data.ip) {
                // Try to get coordinates using fallback
                const coords = getAttackCoordinates(data);
                if (coords.latitude && coords.longitude) {
                    addAttackMarker({ ...data, latitude: coords.latitude, longitude: coords.longitude });
                }
            }
            
            if (data.type === 'cowrie.session.connect') {
                // Flash connection indicator
                const connectionsCard = document.querySelector('#total-connections').closest('.stat-card');
                connectionsCard.classList.add('alert-high');
                setTimeout(() => connectionsCard.classList.remove('alert-high'), 2000);
            }
            
            // Update timeline chart with new attack
            if (data.timestamp) {
                updateTimelineChart(stats.recent_attacks || []);
            }
            
            // Use debounced update to prevent excessive calls
            console.log('Calling debouncedUpdateStats');
            debouncedUpdateStats(data.stats);
        }

        // Add alert
        function addAlert(alert) {
            const container = document.getElementById('alerts-container');
            const alertElement = document.createElement('div');
            alertElement.className = `p-3 rounded-lg smooth-transition ${
                alert.level === 'HIGH' ? 'bg-red-600 bg-opacity-20 border border-red-600' :
                alert.level === 'MEDIUM' ? 'bg-yellow-600 bg-opacity-20 border border-yellow-600' :
                'bg-blue-600 bg-opacity-20 border border-blue-600'
            }`;
            
            alertElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2 mb-1">
                            <span class="text-xs font-semibold ${
                                alert.level === 'HIGH' ? 'text-red-400' :
                                alert.level === 'MEDIUM' ? 'text-yellow-400' :
                                'text-blue-400'
                            }">${alert.level}</span>
                            <span class="text-xs text-gray-400">${formatTime(alert.timestamp)}</span>
                        </div>
                        <p class="text-sm">${alert.message}</p>
                        <p class="text-xs text-gray-400 mt-1">IP: ${alert.ip} | ${alert.country}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.insertBefore(alertElement, container.firstChild);
            
            // Keep only latest 10 alerts
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }

        // Export functions
        function exportCredentials() {
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        function confirmExport() {
            const successOnly = document.getElementById('success-only').checked;
            const url = `/api/export/credentials?success_only=${successOnly}`;
            
            window.open(url, '_blank');
            closeExportModal();
        }

        function exportLogs() {
            const format = document.getElementById('export-format').value;
            const url = `/api/export/logs?format=${format}&limit=1000`;
            window.open(url, '_blank');
        }

        function exportAlerts() {
            const url = '/api/export/alerts?limit=1000';
            window.open(url, '_blank');
        }

        // Utility functions
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        // Show successful logins modal
        function showSuccessfulLoginsModal() {
            // Fetch successful login details from backend with authentication
            fetch('http://192.168.1.19:3333/api/successful-logins', {
                headers: {
                    'Authorization': 'Basic ' + btoa('admin:Cowrie@2026!')
                }
            })
                .then(response => response.json())
                .then(data => {
                    createSuccessfulLoginsModal(data);
                })
                .catch(error => {
                    console.error('Error fetching successful logins:', error);
                    alert('Error loading successful login details');
                });
        }

        function createSuccessfulLoginsModal(logins) {
            // Remove existing modal if present
            const existingModal = document.getElementById('successful-logins-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal HTML
            const modal = document.createElement('div');
            modal.id = 'successful-logins-modal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-900 rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-white">Successful Login Details</h3>
                        <button onclick="this.closest('#successful-logins-modal').remove()" 
                                class="text-gray-400 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-2 text-gray-300">Timestamp</th>
                                    <th class="text-left p-2 text-gray-300">IP Address</th>
                                    <th class="text-left p-2 text-gray-300">Country</th>
                                    <th class="text-left p-2 text-gray-300">Username</th>
                                    <th class="text-left p-2 text-gray-300">Password</th>
                                    <th class="text-left p-2 text-gray-300">Actions After Login</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${logins.map(login => `
                                    <tr class="border-b border-gray-800 hover:bg-gray-800">
                                        <td class="p-2 text-gray-400">${new Date(login.timestamp).toLocaleString()}</td>
                                        <td class="p-2 text-gray-400">${login.ip}</td>
                                        <td class="p-2 text-gray-400">${login.country || 'Unknown'}</td>
                                        <td class="p-2 text-gray-400">${login.username || 'N/A'}</td>
                                        <td class="p-2 text-gray-400">${login.password || 'N/A'}</td>
                                        <td class="p-2 text-gray-400">
                                            <div class="space-y-1">
                                                ${login.actions && login.actions.length > 0 
                                                    ? login.actions.map(action => `
                                                        <div class="text-xs">
                                                            <span class="text-blue-400">${action.type}:</span> 
                                                            <span class="text-gray-300">${action.command || action.path || action.description}</span>
                                                            ${action.timestamp ? `<span class="text-gray-500 text-xs ml-2">${new Date(action.timestamp).toLocaleTimeString()}</span>` : ''}
                                                        </div>
                                                    `).join('')
                                                    : '<span class="text-gray-500 text-xs">No actions recorded</span>'
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${logins.length === 0 ? '<div class="text-center text-gray-400 p-4">No successful logins recorded</div>' : ''}
                    </div>
                </div>
            `;

            // Add modal to body
            document.body.appendChild(modal);

            // Close modal when clicking outside
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
    </script>
</body>
</html>
